# üöÄ API Documentation: Visual Product Search

This document provides a technical overview and detailed endpoint reference for the Visual Product Search API.

* **Audience:** Frontend and Backend Developers
* **API Root:** `http://127.0.0.1:8000` (or your production URL)
* **Interactive Docs:** `http://127.0.0.1:8000/docs`

---

## 1. üß† Core Concepts

Before using the endpoints, it's crucial to understand these design patterns.

### 1.1. Multi-Tenancy
This API is multi-tenant. It does not use a single "master" API key.

* Every API call is authenticated by the `get_shop_info` dependency (from `dependencies/auth.py`).
* This dependency is responsible for validating a user (e.g., from a JWT or API key) and returning a `dict` containing that tenant's specific database credentials (MySQL host, user, password) and Qdrant settings (`qdrant_url`, `qdrant_collection`).
* The `DBOperations` class is initialized *per-request* with these tenant-specific credentials, ensuring data is always isolated to the correct shop.

### 1.2. The Search & Re-ranking Pipeline
The `POST /search_by_image/` endpoint follows a sophisticated two-stage AI process:

1.  **Stage 1: Vector Search (Finds visual similarity)**
    * The user uploads an image.
    * The `DinoEmbeddingModel` (`image_encoder.py`) converts this image into a vector embedding.
    * This vector is sent to Qdrant to find the `top K` (e.g., 30) most visually similar images from the tenant's collection.

2.  **Stage 2: Cross-Encoder Re-ranking (Finds text relevance)**
    * If a `text_query` (e.g., "nike", "running shoe") is provided with the image, the `top K` results from Stage 1 are passed to the `CrossEncoderReranker` (`ranking_encoder.py`).
    * The re-ranker scores the *relevance* between the `text_query` and the `product_name` of each search result.
    * The final list is **re-sorted** based on this relevance score, pushing items that are both visually similar *and* textually relevant to the top.

### 1.3. The Data Ingestion Pipeline
The `POST /add_product/` endpoint is a multi-step process:

1.  **Fetch Metadata:** It takes a `product_id` and queries the tenant's **MySQL** database to get the product's metadata (name, image URLs).
2.  **Download Images:** It asynchronously downloads all associated image URLs using `aiohttp` for high speed.
3.  **Batch Embed:** All downloaded images are sent to the `DinoEmbeddingModel` in a *single batch* for efficient AI processing.
4.  **Batch Upsert:** All new vectors and payloads are sent to Qdrant in a *single batch* `upsert` operation.

### 1.4. Unique Point IDs
A single product can have many images. Each image is a separate "point" in the Qdrant database.

* To make individual images updatable and deletable, each point is given a unique, deterministic ID.
* This ID is generated by `DBOperations.generate_unique_id`:
    `hashlib.md5(f"{product_id}_{img_url}".encode()).hexdigest()`
* This is why the `DELETE /delete_image/` endpoint requires *both* the `product_id` and the `image_url` to reconstruct this unique ID and delete the correct point.

---

## 2. üìã Pydantic Schemas (Data Contracts)

These are the main JSON structures used for requests and responses.

* `ProductID`: Used when you only need to identify a product.
    * `{"product_id": "str"}`
* `ImageLinksRequest`: Used for adding or deleting specific images.
    * `{"product_id": "str", "image_urls": ["str", "str"]}`
* `SearchResult`: The structure for a single search result.
    * `{"product_name": "str", "product_id": "str", "url": "str", "image_similarity": "float", "rerank_score": "float"}`
* `SearchResponse`: The final response from the search endpoint.
    * `{"results": [SearchResult, ...]}`
* `StatusResponse`: A generic response for `POST` or `DELETE` actions.
    * `{"status": "str", "message": "str", "deleted_count": "int", "added_count": "int"}`

---

## 3. üõ†Ô∏è API Endpoint Reference

Details for every endpoint, including request and response formats.

### Health Check

#### `GET /`
* **Description:** A simple health check endpoint to verify the API is running.
* **Method:** `GET`
* **Request:** None.
* **Success Response:** `200 OK`
    ```json
    {
      "status": "ok",
      "service": "visual_search_api",
      "message": "API is running and ready to handle requests."
    }
    ```

---

### Search Endpoints

#### `POST /search_by_image/`
* **Description:** The main visual search endpoint. It finds products by an uploaded image and optionally re-ranks them using a text query.
* **Method:** `POST`
* **Request Type:** `multipart/form-data`
* **Form Fields:**
    * `file` (file): **[Required]** The image file to search with.
    * `text_query` (str): **[Optional]** A text string (e.g., brand, model) to re-rank results for better accuracy.
* **Success Response:** `200 OK`
    * **Body Schema:** `SearchResponse`
    * **Example Response:**
        ```json
        {
          "results": [
            {
              "product_name": "red nike sneaker",
              "product_id": "prod-123",
              "url": "[https.example.com/img1.jpg](https://https.example.com/img1.jpg)",
              "image_similarity": 0.9123,
              "rerank_score": 0.985
            },
            {
              "product_name": "blue adidas shoe",
              "product_id": "prod-456",
              "url": "[https.example.com/img2.jpg](https://https.example.com/img2.jpg)",
              "image_similarity": 0.8991,
              "rerank_score": 0.123
            }
          ]
        }
        ```
* **Error Responses:**
    * `400 Bad Request`: If the file is not an image or is corrupted.
    * `500 Internal Server Error`: If the search or model inference fails.

---

### Product & Image Management

#### `POST /add_product/`
* **Description:** Adds a *new product* to the vector database. This endpoint triggers the full ingestion pipeline: it fetches product data and all its images from MySQL, downloads them, and batch-embeds/upserts them into Qdrant.
* **Method:** `POST`
* **Request Type:** `application/json`
* **Body Schema:** `ProductID`
* **Example Request Body:**
    ```json
    {
      "product_id": "prod-789-new"
    }
    ```
* **Success Response:** `201 Created`
    ```json
    {
      "status": "success",
      "message": "Successfully processed product prod-789-new",
      "total_images_processed": 5
    }
    ```
* **Error Responses:**
    * `404 Not Found`: If the `product_id` does not exist in the tenant's MySQL database.
    * `400 Bad Request`: If no valid image URLs are found for the product or if all image downloads fail.
    * `500 Internal Server Error`: If the database connection or upsert fails.

---

#### `POST /add_new_images/`
* **Description:** Adds *new images* to an *existing product*. Use this to add product images that were not in the original MySQL data.
* **Method:** `POST`
* **Request Type:** `application/json`
* **Body Schema:** `ImageLinksRequest`
* **Example Request Body:**
    ```json
    {
      "product_id": "prod-123",
      "image_urls": [
        "[https.example.com/new_image1.jpg](https://https.example.com/new_image1.jpg)",
        "[https.example.com/new_image2.jpg](https://https.example.com/new_image2.jpg)"
      ]
    }
    ```
* **Success Response:** `201 Created`
    * **Body Schema:** `StatusResponse`
    ```json
    {
      "status": "success",
      "message": "Successfully processed and added 2 new images."
    }
    ```
* **Error Responses:**
    * `404 Not Found`: If the `product_id` does not exist in MySQL (used to get the `product_name`).
    * `400 Bad Request`: If `image_urls` is empty or all provided URLs fail to download.
    * `500 Internal Server Error`: If the upsert fails.

---

#### `DELETE /delete_products/`
* **Description:** Deletes *all* image vectors associated with a specific `product_id` from the Qdrant database. This is used when a product is removed from the catalog.
* **Method:** `DELETE`
* **Request Type:** `application/json`
* **Body Schema:** `ProductID`
* **Example Request Body:**
    ```json
    {
      "product_id": "prod-123-to-delete"
    }
    ```
* **Success Response:** `200 OK`
    * **Body Schema:** `StatusResponse`
    ```json
    {
      "deleted_count": 8,
      "message": "Successfully deleted 8 image vectors for product ID prod-123-to-delete."
    }
    ```
* **Error Responses:**
    * `500 Internal Server Error`: If the Qdrant deletion operation fails.

---

#### `DELETE /delete_image/`
* **Description:** Deletes a *single image vector* from the database. It finds the vector by reconstructing its unique hash ID from the `product_id` and `image_url`.
* **Method:** `DELETE`
* **Request Type:** `application/json`
* **Body Schema:** `ImageLinksRequest`
* **Example Request Body:**
    ```json
    {
      "product_id": "prod-123",
      "image_urls": [
        "[https.example.com/img1.jpg](https://https.example.com/img1.jpg)"
      ]
    }
    ```
* **Success Response:** `200 OK`
    * **Body Schema:** `StatusResponse`
    ```json
    {
      "status": "success",
      "message": "Successfully deleted image. Product ID: prod-123",
      "qdrant_point_id": "a1b2c3d4e5f6..."
    }
    ```
* **Error Responses:**
    * `5P00 Internal Server Error`: If the delete operation fails.